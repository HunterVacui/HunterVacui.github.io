<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Piano Grid</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            color: white;
        }

        .container {
            max-width: 900px;
            width: 100%;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .elevens-bar {
            display: grid;
            grid-template-columns: repeat(21, 1fr);
            gap: 1px;
            margin-bottom: 20px;
            height: 60px;
        }

        .classic-multiples-grid {
            display: grid;
            grid-template-columns: repeat(13, 1fr);
            gap: 1px;
            margin-bottom: 20px;
            height: 260px;
        }

        .piano-grid {
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            gap: 4px;
            margin-bottom: 30px;
            aspect-ratio: 1;
        }

        .key {
            border: 2px solid #888;
            border-radius: 12px;
            font-size: 0.9em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.1s ease;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            user-select: none;
            box-shadow: 0 3px 6px rgba(0,0,0,0.2);
            position: relative;
            min-height: 60px;
        }

        .key.elevens {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            border-color: #ff4757;
            color: white;
            font-size: 0.8em;
        }

        .key.classic {
            color: white;
            font-size: 1.0em;
        }

        .key.inactive {
            background: #555 !important;
            color: #888 !important;
            cursor: not-allowed;
            border-color: #666;
        }

        .key:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0,0,0,0.3);
            border-color: #aaa;
        }

        .key.elevens:hover {
            border-color: #ff3742;
        }

        .key:active, .key.active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            border-color: #4CAF50;
            border-width: 3px;
        }

        .key.center {
            border-color: #FFD700;
            border-width: 3px;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
        }

        .ratio {
            font-size: 0.8em;
            opacity: 0.9;
            font-weight: normal;
        }

        .interval {
            font-size: 0.7em;
            opacity: 0.9;
        }

        .note-name {
            font-size: 0.8em;
            font-weight: bold;
        }

        .frequency {
            font-size: 0.6em;
            opacity: 0.7;
            margin-top: 2px;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .control-group label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        input[type="range"] {
            width: 120px;
        }

        .instructions {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            text-align: center;
            line-height: 1.6;
        }

        .note-info {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.1em;
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 20px;
            font-size: 0.9em;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .legend-dot.center {
            background: #FFD700;
        }

        .legend-dot.elevens {
            background: #ff6b6b;
        }

        @media (max-width: 700px) {
            .piano-grid {
                gap: 6px;
            }
            
            .key {
                font-size: 0.8em;
            }
            
            h1 {
                font-size: 2em;
            }

            .legend {
                flex-direction: column;
                gap: 10px;
            }
        }

        @media (max-width: 600px) {
            .key {
                font-size: 0.45em;
                min-height: 35px;
            }
            
            .elevens-bar {
                height: 20px;
                gap: 1px;
            }
        }

        @media (max-width: 700px) {
            .key {
                font-size: 0.45em;
                min-height: 25px;
            }
            
            .classic-multiples-grid {
                height: 25px;
                gap: 1px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸŽ¹ Dynamic Piano Grid</h1>
        
        <div class="note-info" id="noteInfo">
            <div style="display: flex; align-items: center; justify-content: center; gap: 15px; flex-wrap: wrap;">
                <button id="centerButton" style="background: rgba(255,215,0,0.2); border: 2px solid #FFD700; color: white; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: bold;">
                    Current Center: A4 (440.00 Hz) - Click to Reset
                </button>
                <button id="recenterToggle" style="background: rgba(76,175,80,0.2); border: 2px solid #4CAF50; color: white; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: bold;">
                    Recenter Mode: OFF
                </button>
            </div>
        </div>

        <div class="legend">
            <div class="legend-item">
                <div class="legend-dot center"></div>
                <span>Current Center Note</span>
            </div>
            <div class="legend-item">
                <div class="legend-dot elevens"></div>
                <span>11-limit ratios</span>
            </div>
            <div class="legend-item">
                <span>ðŸ’¡ Click to play â€¢ Toggle recenter mode to change center</span>
            </div>
        </div>

        <div class="controls">
            <div class="control-group">
                <label for="volume">Volume</label>
                <input type="range" id="volume" min="0" max="1" step="0.1" value="0.3">
            </div>
            <div class="control-group">
                <label for="waveform">Waveform</label>
                <select id="waveform">
                    <option value="sawtooth">Sawtooth</option>
                    <option value="square">Square</option>
                    <option value="sine">Sine</option>
                    <option value="triangle">Triangle</option>
                </select>
            </div>
            <div class="control-group">
                <label for="attack">Attack (ms)</label>
                <input type="range" id="attack" min="1" max="200" value="50">
            </div>
            <div class="control-group">
                <label for="decay">Decay (ms)</label>
                <input type="range" id="decay" min="50" max="2000" value="1000">
            </div>
        </div>

        <div class="elevens-bar" id="elevensBar">
            <!-- 11s bar will be generated by JavaScript -->
        </div>

        <div class="classic-multiples-grid" id="classicMultiplesGrid">
            <!-- Grid will be generated by JavaScript -->
        </div>

        <div class="piano-grid" id="pianoGrid">
            <!-- Grid will be generated by JavaScript -->
        </div>

        <div class="instructions">
            <h3>How to Play</h3>
            <p>â€¢ <strong>Click</strong> any key to play its note</p>
            <p>â€¢ <strong>Toggle recenter mode</strong> and then click a key to make it the new center</p>
            <p>â€¢ <strong>Center button (gold)</strong>: Click to reset to A4 (440 Hz)</p>
            <p>â€¢ <strong>Red bar</strong>: 11-limit ratios (1/11, 2/11, ... 11/2, 11/1)</p>
            <p>â€¢ Use mouse/touch or keyboard (1-9, Q-O, A-L, Z-M)</p>
            <p>â€¢ Colors represent frequency: darker = lower, brighter = higher</p>
            <p>â€¢ Explore infinite musical space by recentering!</p>
        </div>

        <div class="copyright">
            Copyright (c) 2025 vacui.dev, all rights reserved
        </div>
    </div>

    <script>
        class DynamicPiano {
            constructor() {
                this.audioContext = null;
                this.currentBaseFreq = 440; // A4
                this.currentNoteName = 'A4';
                this.currentCenterPosition = 40; // Center of 9x9 grid (5th row, 5th column, 0-indexed)
                this.recenterMode = true;
                this.activeOscillators = new Map();
                this.grid = document.getElementById('pianoGrid');
                this.elevensBar = document.getElementById('elevensBar');
                this.classicMultiplesGrid = document.getElementById('classicMultiplesGrid');
                this.noteInfo = document.getElementById('noteInfo');
                
                this.minFreq = 27.5; // A0
                this.maxFreq = 4186; // C8

                this.setupGrid();
                this.initAudio();
                this.updateDisplay();
                this.bindEvents();
            }

            setupGrid() {
                // Create elevens bar (21 keys)
                this.elevensBar.innerHTML = '';
                for (let i = 0; i < 21; i++) {
                    const key = document.createElement('div');
                    key.className = 'key elevens';
                    key.dataset.position = `elevens-${i}`;
                    this.elevensBar.appendChild(key);
                }

                this.classicMultiplesGrid.innerHTML = '';
                for (let i = 0; i < 52; i++) {
                    const key = document.createElement('div');
                    key.className = 'key classic';
                    key.dataset.position = `classic-${i}`;
                    this.classicMultiplesGrid.appendChild(key);
                }

                // Create main grid
                this.grid.innerHTML = '';
                for (let i = 0; i < 81; i++) {
                    const key = document.createElement('div');
                    key.className = 'key';
                    key.dataset.position = i.toString();
                    this.grid.appendChild(key);
                }

                this.keys = document.querySelectorAll('.key');
                this.mainKeys = document.querySelectorAll('.piano-grid .key');
                this.elevensKeys = document.querySelectorAll('.elevens-bar .key');
                this.classicKeys = document.querySelectorAll('.classic-multiples-grid .key');

                // 11-limit ratios for the top bar
                this.elevensMultipliers = [
                    1/11, 2/11, 3/11, 4/11, 5/11, 6/11, 7/11, 8/11, 9/11, 10/11,
                    11/11,
                    11/10, 11/9, 11/8, 11/7, 11/6, 11/5, 11/4, 11/3, 11/2, 11/1
                ];

                this.classicMultipliers = [
                //    /7      /6     /5     /4     /3       /2    1      2nd     3rd    4th    5th     6th   7th
                   27/50,  16/27, 16/25, 32/45,   7/9,    9/10, 2/1,    10/9,   9/7, 45/32, 25/16,  27/16, 50/27, // Augmented
                    8/15,    3/5,   2/3,   3/4,   4/5,     8/9, 1/1,     9/8,   5/4,   4/3,   3/2,    5/3,  15/8, // Major / Perfect
                     5/9,    5/8, 27/40, 25/32,   5/6,   15/16, 1/2,   16/15,   6/5, 32/25, 40/27,    8/5,   9/5, // Minor
                    9/16, 75/128,   5/7, 45/64, 27/32, 243/256, 1/4, 256/243, 32/27, 64/45,   7/5, 128/75,  16/9, // Diminished
                ];

                this.multipliers = [
                       0,  10/9,  9/5, 16/15, 10/3, 32/25, 40/27,  16/9,   8/1, 
                    9/10,     0,  9/7,   8/5, 5/2,    8/3,   9/2,   5/1,   9/1, 
                     5/9,   7/9,    0,   6/5, 9/4,    7/2,   4/1,  11/4,   7/1, 
                   15/16,   5/8,  5/6,     0, 5/4,    2/1,   7/3,   3/1,   6/1, 
                    3/10,   2/5,  4/9,   4/5, 1/1,    4/3,   3/2,   5/3,  15/8, 
                   25/32,   3/8,  2/7,   1/2, 3/4,      0,   7/5,   7/4,   9/8, 
                   27/40,   2/9,  1/4,   3/7, 2/3,    5/7,     0,   8/7,   7/6, 
                    9/16,   1/5,  4/11,  1/3, 3/5,    4/7,   7/8,     0,  10/7, 
                     1/8,   1/9,  1/7,   1/6, 8/15,   8/9,   6/7,  7/10,     0, 
                ];

                // Apply center class to the current center position
                this.updateCenterKey();
            }

            updateCenterKey() {
                this.keys.forEach(k => k.classList.remove('center'));
                this.mainKeys[this.currentCenterPosition].classList.add('center');
            }

            getPositionRatio(position) {
                if (typeof position === 'string' && position.startsWith('elevens-')) {
                    const index = parseInt(position.split('-')[1]);
                    return { ratio: this.elevensMultipliers[index] };
                }
                else if (typeof position === 'string' && position.startsWith('classic-')) {
                    const index = parseInt(position.split('-')[1]);
                    return { ratio: this.classicMultipliers[index] };
                }
                else {
                    return { ratio: this.multipliers[position] };
                }
            }

            gcd(a, b) {
                while (b !== 0) {
                    let temp = b;
                    b = a % b;
                    a = temp;
                }
                return a;
            }

            simplifyRatio(num, den) {
                const divisor = this.gcd(num, den);
                return {
                    numerator: num / divisor,
                    denominator: den / divisor
                };
            }

            getIntervalName(ratio) {
                const cents = 1200 * Math.log2(ratio);
                
                // Common interval ratios and their names
                const intervals = [
                    // Unison and Octave
                    { ratio: 1/1, name: 'Unison' },

                    // Seconds
                    { ratio: 256/243, name: 'Diminished 2nd' }, // very small
                    { ratio: 16/15, name: 'Minor 2nd' },
                    { ratio: 9/8, name: 'Major 2nd' },
                    { ratio: 10/9, name: 'Augmented 2nd' },

                    // Thirds
                    { ratio: 32/27, name: 'Diminished 3rd' },
                    { ratio: 6/5, name: 'Minor 3rd' },
                    { ratio: 5/4, name: 'Major 3rd' },
                    { ratio: 9/7, name: 'Augmented 3rd' },

                    // Fourths
                    { ratio: 64/45, name: 'Diminished 4th' },
                    { ratio: 32/25, name: 'Minor 4th' },
                    { ratio: 4/3, name: 'Perfect 4th' },
                    { ratio: 45/32, name: 'Augmented 4th' },

                    // Tritone
                    { ratio: 7/5, name: 'Tritone' },            // alternative to aug4/dim5
                                    
                    // Fifths
                    { ratio: 64/45, name: 'Diminished 5th' },   // duplicate of dim4, see note
                    { ratio: 40/27, name: 'Minor 5th' },        // rare, narrow fifth
                    { ratio: 3/2, name: 'Perfect 5th' },
                    { ratio: 25/16, name: 'Augmented 5th' },
                                    
                    // Sixths
                    { ratio: 128/75, name: 'Diminished 6th' }, // same as dim 7th; tuning-dependent
                    { ratio: 8/5, name: 'Minor 6th' },
                    { ratio: 5/3, name: 'Major 6th' },
                    { ratio: 27/16, name: 'Augmented 6th' },

                    // Sevenths
                    { ratio: 16/9, name: 'Minor 7th' },
                    { ratio: 9/5, name: 'Minor 7th (alt)' },
                    { ratio: 15/8, name: 'Major 7th' },
                    { ratio: 50/27, name: 'Augmented 7th' },

                    { ratio: 2/1, name: 'Octave' },
                ];

                // Check for exact matches first
                for (let interval of intervals) {
                    if (Math.abs(ratio - interval.ratio) < 0.001) {
                        return interval.name;
                    }
                }

                // Check for octave multiples/divisions
                let tempRatio = ratio;
                let octaves = 0;
                
                // Reduce to within one octave
                while (tempRatio >= 2) {
                    tempRatio /= 2;
                    octaves++;
                }
                while (tempRatio < 1) {
                    tempRatio *= 2;
                    octaves--;
                }

                // Check reduced ratio against intervals
                for (let interval of intervals) {
                    if (Math.abs(tempRatio - interval.ratio) < 0.001) {
                        if (octaves === 0) {
                            return interval.name;
                        } else if (octaves > 0) {
                            return `${interval.name}+${octaves}oct`;
                        } else {
                            return `${interval.name}${octaves}oct`;
                        }
                    }
                }

                // If no exact match, return cents
                const centsRounded = Math.round(cents);
                return `${centsRounded}Â¢`;
            }

            getFrequencyColor(freq) {
                // Exponential scale from minFreq to maxFreq
                const logMin = Math.log(this.minFreq);
                const logMax = Math.log(this.maxFreq);
                const logFreq = Math.log(Math.max(this.minFreq, Math.min(this.maxFreq, freq)));
                
                const intensity = (logFreq - logMin) / (logMax - logMin);
                
                // Use HSL for better color distribution
                const hue = intensity * 280; // From red-purple to blue
                const saturation = 70;
                const lightness = 20 + intensity * 60; // 20% to 80%
                
                return `hsl(${hue}, ${saturation}%, ${lightness}%)`;
            }

            getTextColor(freq) {
                const logMin = Math.log(this.minFreq);
                const logMax = Math.log(this.maxFreq);
                const logFreq = Math.log(Math.max(this.minFreq, Math.min(this.maxFreq, freq)));
                const intensity = (logFreq - logMin) / (logMax - logMin);
                
                return intensity > 0.5 ? '#000' : '#fff';
            }

            async initAudio() {
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    if (this.audioContext.state === 'suspended') {
                        await this.audioContext.resume();
                    }
                } catch (e) {
                    console.error('Audio context initialization failed:', e);
                }
            }

            getNoteName(frequency) {
                const A4 = 440;
                const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];

                // Calculate semitone distance from A4 (can be fractional)
                const semitonesFromA4 = 12 * Math.log2(frequency / A4);

                // Round to nearest semitone for exact match check
                const nearestSemitone = Math.round(semitonesFromA4);
                const exactFrequency = A4 * Math.pow(2, nearestSemitone / 12);

                // Tight tolerance for exact match
                if (Math.abs(frequency - exactFrequency) < 1) {
                    const noteIndex = ((nearestSemitone + 9) % 12 + 12) % 12;
                    const octave = Math.floor((nearestSemitone + 9) / 12) + 4;
                    return `${noteNames[noteIndex]}${octave}`;
                }

                // Not exact â€” find bounding notes
                const lowerSemitone = Math.floor(semitonesFromA4);
                const upperSemitone = lowerSemitone + 1;

                const lowerNoteIndex = ((lowerSemitone + 9) % 12 + 12) % 12;
                const upperNoteIndex = ((upperSemitone + 9) % 12 + 12) % 12;

                const lowerOctave = Math.floor((lowerSemitone + 9) / 12) + 4;
                const upperOctave = Math.floor((upperSemitone + 9) / 12) + 4;

                const lowerNote = `${noteNames[lowerNoteIndex]}${lowerOctave}`;
                const upperNote = `${noteNames[upperNoteIndex]}${upperOctave}`;

                return `${lowerNote}â€“${upperNote}`;
            }

            updateDisplay() {
                // Update elevens bar
                this.elevensKeys.forEach((key, index) => {
                    const ratio = this.elevensMultipliers[index];
                    const freq = this.currentBaseFreq * ratio;
                    const noteName = this.getNoteName(freq);
                    const intervalName = this.getIntervalName(ratio);
                    
                    // Keep the red styling for elevens
                    key.innerHTML = `
                        <div class="frequency">${freq.toFixed(1)}Hz</div>
                    `;
                });

                // Update classic multiplier bar
                this.classicKeys.forEach((key, index) => {
                    const ratio = this.classicMultipliers[index];
                    const freq = this.currentBaseFreq * ratio;
                    const noteName = this.getNoteName(freq);
                    const intervalName = this.getIntervalName(ratio);
                    
                    const bgColor = this.getFrequencyColor(freq);
                    key.style.backgroundColor = bgColor;
                    key.innerHTML = `
                        <div class="interval">${intervalName}</div>
                    `;
                });

                // Update main grid
                this.mainKeys.forEach((key, index) => {
                    const { ratio } = this.getPositionRatio(index);
                    const freq = this.currentBaseFreq * ratio;
                    
                    // Handle inactive keys (ratio = 0 or freq out of bounds)
                    if (freq < this.minFreq || freq > this.maxFreq) {
                        key.classList.add('inactive');
                        key.innerHTML = '<div style="opacity: 0.5;">â€”</div>';
                        return;
                    }
                    
                    key.classList.remove('inactive');
                    const noteName = this.getNoteName(freq);
                    const intervalName = this.getIntervalName(ratio);
                    const bgColor = this.getFrequencyColor(freq);
                    const textColor = this.getTextColor(freq);
                    
                    key.style.backgroundColor = bgColor;
                    key.style.color = textColor;
                    
                    key.innerHTML = `
                        <div class="interval">${intervalName}</div>
                        <div class="note-name">${noteName}</div>
                        <div class="frequency">${freq.toFixed(1)}Hz</div>
                    `;
                });

                // Update center button text
                const centerButton = document.getElementById('centerButton');
                centerButton.textContent = `Current Center: ${this.currentNoteName} (${this.currentBaseFreq.toFixed(2)} Hz) - Click to Reset`;
                
                // Update recenter toggle button
                const recenterToggle = document.getElementById('recenterToggle');
                recenterToggle.textContent = `Recenter Mode: ${this.recenterMode ? 'ON' : 'OFF'}`;
                recenterToggle.style.background = this.recenterMode ? 'rgba(255,152,0,0.3)' : 'rgba(76,175,80,0.2)';
                recenterToggle.style.borderColor = this.recenterMode ? '#FF9800' : '#4CAF50';
            }

            async playNote(position) {
                const { ratio } = this.getPositionRatio(position);
                const frequency = this.currentBaseFreq * ratio;
                
                // Don't play inactive keys
                if (frequency < this.minFreq || frequency > this.maxFreq) {
                    return;
                }

                if (!this.audioContext) {
                    await this.initAudio();
                }

                const volume = document.getElementById('volume').value;
                const waveform = document.getElementById('waveform').value;
                const attack = parseInt(document.getElementById('attack').value) / 1000;
                const decay = parseInt(document.getElementById('decay').value) / 1000;

                // Stop any existing note for this position
                if (this.activeOscillators.has(position)) {
                    this.stopNote(position);
                }

                // Create oscillator and gain node
                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                
                oscillator.type = waveform;
                oscillator.frequency.setValueAtTime(frequency, this.audioContext.currentTime);
                
                // Envelope: attack and decay
                gainNode.gain.setValueAtTime(0, this.audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(volume, this.audioContext.currentTime + attack);
                gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + attack + decay);

                oscillator.connect(gainNode);
                gainNode.connect(this.audioContext.destination);

                oscillator.start();
                oscillator.stop(this.audioContext.currentTime + attack + decay + 0.1);

                this.activeOscillators.set(position, { oscillator, gainNode });

                // Clean up after note ends
                oscillator.onended = () => {
                    this.activeOscillators.delete(position);
                };

                // Update center frequency if recenter mode is on (only for main grid)
                if (this.recenterMode && typeof position === 'number') {
                    this.currentBaseFreq = frequency;
                    this.currentNoteName = this.getNoteName(frequency);
                    this.currentCenterPosition = position;
                    this.updateCenterKey();
                    this.updateDisplay();
                }

                // Visual feedback
                const key = document.querySelector(`[data-position="${position}"]`);
                key.classList.add('active');
                setTimeout(() => key.classList.remove('active'), 200);
            }

            stopNote(position) {
                if (this.activeOscillators.has(position)) {
                    const { oscillator, gainNode } = this.activeOscillators.get(position);
                    gainNode.gain.cancelScheduledValues(this.audioContext.currentTime);
                    gainNode.gain.setValueAtTime(gainNode.gain.value, this.audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.1);
                    oscillator.stop(this.audioContext.currentTime + 0.1);
                    this.activeOscillators.delete(position);
                }
            }

            bindEvents() {
                // Center button to reset to A4
                const centerButton = document.getElementById('centerButton');
                centerButton.addEventListener('click', () => {
                    this.currentBaseFreq = 440; // A4
                    this.currentNoteName = 'A4';
                    this.currentCenterPosition = 27; // Center of 8x8 grid
                    this.updateCenterKey();
                    this.updateDisplay();
                });

                // Recenter mode toggle
                const recenterToggle = document.getElementById('recenterToggle');
                recenterToggle.addEventListener('click', () => {
                    this.recenterMode = !this.recenterMode;
                    this.updateDisplay();
                });

                // Key events - elevens bar
                this.elevensKeys.forEach((key, index) => {
                    key.addEventListener('click', () => this.playNote(`elevens-${index}`));
                });

                this.classicKeys.forEach((key, index) => {
                    key.addEventListener('click', () => this.playNote(`classic-${index}`));
                });

                // Key events - main grid
                this.mainKeys.forEach((key, index) => {
                    key.addEventListener('click', () => this.playNote(index));
                });

                // Keyboard events
                document.addEventListener('keydown', (e) => {
                    // Map keyboard to center section
                    const keyMap = {
                        'Digit1': 17, 'Digit2': 8, 'Digit3': 19, 'Digit4': 20, 'Digit5': 21, 'Digit6': 22, 'Digit7': 23, 'Digit8': 24, 'Digit9': 25, 'Digit0': 26,
                        'KeyQ': 27, 'KeyW': 28, 'KeyE': 29, 'KeyR': 30, 'KeyT': 31, 'KeyY': 32, 'KeyU': 33, 'KeyI': 34, 'KeyO': 35,
                        'KeyA': 36, 'KeyS': 37, 'KeyD': 38, 'KeyF': 39, 'KeyG': 40, 'KeyH': 41, 'KeyJ': 42, 'KeyK': 43, 'KeyL': 44,
                        'KeyZ': 47, 'KeyX': 46, 'KeyC': 47, 'KeyV': 48, 'KeyB': 49, 'KeyN': 50, 'KeyM': 51,
                    };

                    if (keyMap.hasOwnProperty(e.code)) {
                        e.preventDefault();
                        this.playNote(keyMap[e.code]);
                    }
                });

                // Touch events for mobile
                this.keys.forEach((key, index) => {
                    key.addEventListener('touchstart', (e) => {
                        e.preventDefault();
                        this.playNote(index);
                    });
                });
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new DynamicPiano();
        });

        // Handle audio context resume on user interaction
        document.addEventListener('click', async () => {
            if (window.audioContext && window.audioContext.state === 'suspended') {
                await window.audioContext.resume();
            }
        }, { once: true });
    </script>
</body>
</html>