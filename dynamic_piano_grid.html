<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Piano Grid</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            color: white;
        }

        .container {
            max-width: 900px;
            width: 100%;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .piano-grid {
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            gap: 4px;
            margin-bottom: 30px;
            aspect-ratio: 1;
        }

        .key {
            border: 2px solid #888;
            border-radius: 12px;
            font-size: 0.9em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.1s ease;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            user-select: none;
            box-shadow: 0 3px 6px rgba(0,0,0,0.2);
            position: relative;
            min-height: 60px;
        }

        .key.inactive {
            background: #555 !important;
            color: #888 !important;
            cursor: not-allowed;
            border-color: #666;
        }

        .key:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0,0,0,0.3);
            border-color: #aaa;
        }

        .key:active, .key.active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            border-color: #4CAF50;
            border-width: 3px;
        }

        .key.center {
            border-color: #FFD700;
            border-width: 3px;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
        }

        .ratio {
            font-size: 0.8em;
            opacity: 0.9;
            font-weight: normal;
        }

        .interval {
            font-size: 0.7em;
            opacity: 0.9;
        }

        .note-name {
            font-size: 0.8em;
            font-weight: bold;
        }

        .frequency {
            font-size: 0.6em;
            opacity: 0.7;
            margin-top: 2px;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .control-group label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        input[type="range"] {
            width: 120px;
        }

        .instructions {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            text-align: center;
            line-height: 1.6;
        }

        .note-info {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.1em;
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 20px;
            font-size: 0.9em;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .legend-dot.center {
            background: #FFD700;
        }

        @media (max-width: 700px) {
            .piano-grid {
                gap: 6px;
            }
            
            .key {
                font-size: 0.8em;
            }
            
            h1 {
                font-size: 2em;
            }

            .legend {
                flex-direction: column;
                gap: 10px;
            }
        }

        @media (max-width: 600px) {
            .key {
                font-size: 0.45em;
                min-height: 35px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸŽ¹ Dynamic Piano Grid</h1>
        
        <div class="note-info" id="noteInfo">
            <div style="display: flex; align-items: center; justify-content: center; gap: 15px; flex-wrap: wrap;">
                <button id="centerButton" style="background: rgba(255,215,0,0.2); border: 2px solid #FFD700; color: white; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: bold;">
                    Current Center: A4 (440.00 Hz) - Click to Reset
                </button>
                <button id="recenterToggle" style="background: rgba(76,175,80,0.2); border: 2px solid #4CAF50; color: white; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: bold;">
                    Recenter Mode: OFF
                </button>
            </div>
        </div>

        <div class="legend">
            <div class="legend-item">
                <div class="legend-dot center"></div>
                <span>Current Center Note</span>
            </div>
            <div class="legend-item">
                <span>ðŸ’¡ Click to play â€¢ Toggle recenter mode to change center</span>
            </div>
        </div>

        <div class="controls">
            <div class="control-group">
                <label for="volume">Volume</label>
                <input type="range" id="volume" min="0" max="1" step="0.1" value="0.3">
            </div>
            <div class="control-group">
                <label for="waveform">Waveform</label>
                <select id="waveform">
                    <option value="sawtooth">Sawtooth</option>
                    <option value="square">Square</option>
                    <option value="sine">Sine</option>
                    <option value="triangle">Triangle</option>
                </select>
            </div>
            <div class="control-group">
                <label for="attack">Attack (ms)</label>
                <input type="range" id="attack" min="1" max="200" value="50">
            </div>
            <div class="control-group">
                <label for="decay">Decay (ms)</label>
                <input type="range" id="decay" min="50" max="2000" value="1000">
            </div>
        </div>

        <div class="piano-grid" id="pianoGrid">
            <!-- Grid will be generated by JavaScript -->
        </div>

        <div class="instructions">
            <h3>How to Play</h3>
            <p>â€¢ <strong>Click</strong> any key to play its note</p>
            <p>â€¢ <strong>Toggle recenter mode</strong> and then click a key to make it the new center</p>
            <p>â€¢ <strong>Center button (gold)</strong>: Click to reset to A4 (440 Hz)</p>
            <p>â€¢ Use mouse/touch or keyboard (1-9, Q-O, A-L, Z-M)</p>
            <p>â€¢ Colors represent frequency: darker = lower, brighter = higher</p>
            <p>â€¢ Explore infinite musical space by recentering!</p>
        </div>

        <div class="copyright">
            Copyright (c) 2025 vacui.dev, all rights reserved
        </div>
    </div>

    <script>
        class DynamicPiano {
            constructor() {
                this.audioContext = null;
                this.currentBaseFreq = 440; // A4
                this.currentNoteName = 'A4';
                this.currentCenterPosition = 40; // Center of 9x9 grid (5th row, 5th column, 0-indexed)
                this.recenterMode = false;
                this.activeOscillators = new Map();
                this.grid = document.getElementById('pianoGrid');
                this.noteInfo = document.getElementById('noteInfo');
                
                this.minFreq = 27.5; // A0
                this.maxFreq = 4186; // C8

                this.setupGrid();
                this.initAudio();
                this.updateDisplay();
                this.bindEvents();
            }

            setupGrid() {
                // Create buttons
                this.grid.innerHTML = '';
                for (let i = 0; i < 81; i++) {
                    const key = document.createElement('div');
                    key.className = 'key';
                    key.dataset.position = i.toString();
                    this.grid.appendChild(key);
                }

                this.keys = document.querySelectorAll('.key');
                
                this.multipliers = [
                      7/4,   11/3, 10/7,  8/3,   3, 10/3,    6,   8,     9,
                     16/15,   5/4, 13/8,    0,   2, 10/9,    0,   4,     7,
                      7/6,   11/8,  9/8,  6/7, 3/2,  6/5,  5/3, 27/16,   5,
                    256/243,  2/5,  5/7,  3/4, 4/3, 11/6,  8/5,   3,    5/2,
                      2/3,    3/4,  1/3,  1/2,   1,  3/2,  4/3,   2,    9/5,
                      2/9,  16/27,   8/9, 5/6, 2/3,  6/11,  0,   0,    9/2,
                      1/5,     0,   3/5,  5/8, 1/2,  3/5,  7/5,  8/11,   4,
                      1/7,    1/4,   0,  9/10, 1/3,   0,   8/13, 8/6,  15/16,
                      1/9,    1/8,  1/6,  1/3, 1/4,  3/8,  7/10, 4/5,   4/7,
                ];

                // Apply center class to the current center position
                this.updateCenterKey();
            }

            updateCenterKey() {
                this.keys.forEach(k => k.classList.remove('center'));
                this.keys[this.currentCenterPosition].classList.add('center');
            }

            getPositionRatio(position) {
                return { ratio: this.multipliers[position] };
            }

            gcd(a, b) {
                while (b !== 0) {
                    let temp = b;
                    b = a % b;
                    a = temp;
                }
                return a;
            }

            simplifyRatio(num, den) {
                const divisor = this.gcd(num, den);
                return {
                    numerator: num / divisor,
                    denominator: den / divisor
                };
            }

            getIntervalName(ratio) {
                const cents = 1200 * Math.log2(ratio);
                
                // Common interval ratios and their names
                const intervals = [
                    // Unison and Octave
                    { ratio: 1/1, name: 'Unison' },

                    // Seconds
                    { ratio: 256/243, name: 'Diminished 2nd' }, // very small
                    { ratio: 16/15, name: 'Minor 2nd' },
                    { ratio: 9/8, name: 'Major 2nd' },
                    { ratio: 10/9, name: 'Augmented 2nd' },

                    // Thirds
                    { ratio: 32/27, name: 'Diminished 3rd' },
                    { ratio: 6/5, name: 'Minor 3rd' },
                    { ratio: 5/4, name: 'Major 3rd' },
                    { ratio: 9/7, name: 'Augmented 3rd' },

                    // Fourths
                    { ratio: 64/45, name: 'Diminished 4th' },
                    { ratio: 32/25, name: 'Minor 4th' },
                    { ratio: 4/3, name: 'Perfect 4th' },
                    { ratio: 45/32, name: 'Augmented 4th' },

                    // Tritone
                    { ratio: 7/5, name: 'Tritone' },            // alternative to aug4/dim5
                                    
                    // Fifths
                    { ratio: 64/45, name: 'Diminished 5th' },   // duplicate of dim4, see note
                    { ratio: 40/27, name: 'Minor 5th' },        // rare, narrow fifth
                    { ratio: 3/2, name: 'Perfect 5th' },
                    { ratio: 25/16, name: 'Augmented 5th' },
                                    
                    // Sixths
                    { ratio: 128/75, name: 'Diminished 6th' }, // same as dim 7th; tuning-dependent
                    { ratio: 8/5, name: 'Minor 6th' },
                    { ratio: 5/3, name: 'Major 6th' },
                    { ratio: 27/16, name: 'Augmented 6th' },

                    // Sevenths
                    { ratio: 16/9, name: 'Minor 7th' },
                    { ratio: 9/5, name: 'Minor 7th (alt)' },
                    { ratio: 15/8, name: 'Major 7th' },
                    { ratio: 50/27, name: 'Augmented 7th' },

                    { ratio: 2/1, name: 'Octave' },
                ];

                // Check for exact matches first
                for (let interval of intervals) {
                    if (Math.abs(ratio - interval.ratio) < 0.001) {
                        return interval.name;
                    }
                }

                // Check for octave multiples/divisions
                let tempRatio = ratio;
                let octaves = 0;
                
                // Reduce to within one octave
                while (tempRatio >= 2) {
                    tempRatio /= 2;
                    octaves++;
                }
                while (tempRatio < 1) {
                    tempRatio *= 2;
                    octaves--;
                }

                // Check reduced ratio against intervals
                for (let interval of intervals) {
                    if (Math.abs(tempRatio - interval.ratio) < 0.001) {
                        if (octaves === 0) {
                            return interval.name;
                        } else if (octaves > 0) {
                            return `${interval.name}+${octaves}oct`;
                        } else {
                            return `${interval.name}${octaves}oct`;
                        }
                    }
                }

                // If no exact match, return cents
                const centsRounded = Math.round(cents);
                return `${centsRounded}Â¢`;
            }

            getFrequencyColor(freq) {
                // Exponential scale from minFreq to maxFreq
                const logMin = Math.log(this.minFreq);
                const logMax = Math.log(this.maxFreq);
                const logFreq = Math.log(Math.max(this.minFreq, Math.min(this.maxFreq, freq)));
                
                const intensity = (logFreq - logMin) / (logMax - logMin);
                
                // Use HSL for better color distribution
                const hue = intensity * 280; // From red-purple to blue
                const saturation = 70;
                const lightness = 20 + intensity * 60; // 20% to 80%
                
                return `hsl(${hue}, ${saturation}%, ${lightness}%)`;
            }

            getTextColor(freq) {
                const logMin = Math.log(this.minFreq);
                const logMax = Math.log(this.maxFreq);
                const logFreq = Math.log(Math.max(this.minFreq, Math.min(this.maxFreq, freq)));
                const intensity = (logFreq - logMin) / (logMax - logMin);
                
                return intensity > 0.5 ? '#000' : '#fff';
            }

            async initAudio() {
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    if (this.audioContext.state === 'suspended') {
                        await this.audioContext.resume();
                    }
                } catch (e) {
                    console.error('Audio context initialization failed:', e);
                }
            }

            getNoteName(frequency) {
                const A4 = 440;
                const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
                
                const semitonesFromA4 = Math.round(12 * Math.log2(frequency / A4));
                const octave = Math.floor((semitonesFromA4 + 9) / 12) + 4;
                const noteIndex = ((semitonesFromA4 + 9) % 12 + 12) % 12;
                const noteName = noteNames[noteIndex];
                
                return `${noteName}${octave}`;
            }

            updateDisplay() {
                this.keys.forEach((key, index) => {
                    const { ratio } = this.getPositionRatio(index);
                    
                    // Handle inactive keys (ratio = 0)
                    if (ratio === 0) {
                        key.classList.add('inactive');
                        key.innerHTML = '<div style="opacity: 0.5;">â€”</div>';
                        return;
                    }
                    
                    key.classList.remove('inactive');
                    const freq = Math.max(this.minFreq, Math.min(this.maxFreq, this.currentBaseFreq * ratio));
                    const noteName = this.getNoteName(freq);
                    const intervalName = this.getIntervalName(ratio);
                    const bgColor = this.getFrequencyColor(freq);
                    const textColor = this.getTextColor(freq);
                    
                    key.style.backgroundColor = bgColor;
                    key.style.color = textColor;
                    
                    key.innerHTML = `
                        <div class="interval">${intervalName}</div>
                        <div class="note-name">${noteName}</div>
                        <div class="frequency">${freq.toFixed(1)}Hz</div>
                    `;
                });

                // Update center button text
                const centerButton = document.getElementById('centerButton');
                centerButton.textContent = `Current Center: ${this.currentNoteName} (${this.currentBaseFreq.toFixed(2)} Hz) - Click to Reset`;
                
                // Update recenter toggle button
                const recenterToggle = document.getElementById('recenterToggle');
                recenterToggle.textContent = `Recenter Mode: ${this.recenterMode ? 'ON' : 'OFF'}`;
                recenterToggle.style.background = this.recenterMode ? 'rgba(255,152,0,0.3)' : 'rgba(76,175,80,0.2)';
                recenterToggle.style.borderColor = this.recenterMode ? '#FF9800' : '#4CAF50';
            }

            async playNote(position) {
                const { ratio } = this.getPositionRatio(position);
                
                // Don't play inactive keys
                if (ratio === 0) {
                    return;
                }

                if (!this.audioContext) {
                    await this.initAudio();
                }

                const frequency = Math.max(this.minFreq, Math.min(this.maxFreq, this.currentBaseFreq * ratio));
                const volume = document.getElementById('volume').value;
                const waveform = document.getElementById('waveform').value;
                const attack = parseInt(document.getElementById('attack').value) / 1000;
                const decay = parseInt(document.getElementById('decay').value) / 1000;

                // Stop any existing note for this position
                if (this.activeOscillators.has(position)) {
                    this.stopNote(position);
                }

                // Create oscillator and gain node
                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                
                oscillator.type = waveform;
                oscillator.frequency.setValueAtTime(frequency, this.audioContext.currentTime);
                
                // Envelope: attack and decay
                gainNode.gain.setValueAtTime(0, this.audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(volume, this.audioContext.currentTime + attack);
                gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + attack + decay);

                oscillator.connect(gainNode);
                gainNode.connect(this.audioContext.destination);

                oscillator.start();
                oscillator.stop(this.audioContext.currentTime + attack + decay + 0.1);

                this.activeOscillators.set(position, { oscillator, gainNode });

                // Clean up after note ends
                oscillator.onended = () => {
                    this.activeOscillators.delete(position);
                };

                // Update center frequency if recenter mode is on
                if (this.recenterMode) {
                    this.currentBaseFreq = frequency;
                    this.currentNoteName = this.getNoteName(frequency);
                    this.currentCenterPosition = position;
                    this.updateCenterKey();
                    this.updateDisplay();
                    // Turn off recenter mode after use
                    this.recenterMode = false;
                }

                // Visual feedback
                const key = this.keys[position];
                key.classList.add('active');
                setTimeout(() => key.classList.remove('active'), 200);
            }

            stopNote(position) {
                if (this.activeOscillators.has(position)) {
                    const { oscillator, gainNode } = this.activeOscillators.get(position);
                    gainNode.gain.cancelScheduledValues(this.audioContext.currentTime);
                    gainNode.gain.setValueAtTime(gainNode.gain.value, this.audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + 0.1);
                    oscillator.stop(this.audioContext.currentTime + 0.1);
                    this.activeOscillators.delete(position);
                }
            }

            bindEvents() {
                // Center button to reset to A4
                const centerButton = document.getElementById('centerButton');
                centerButton.addEventListener('click', () => {
                    this.currentBaseFreq = 440; // A4
                    this.currentNoteName = 'A4';
                    this.currentCenterPosition = 40; // Center of 9x9 grid
                    this.updateCenterKey();
                    this.updateDisplay();
                });

                // Recenter mode toggle
                const recenterToggle = document.getElementById('recenterToggle');
                recenterToggle.addEventListener('click', () => {
                    this.recenterMode = !this.recenterMode;
                    this.updateDisplay();
                });

                // Key events
                this.keys.forEach((key, index) => {
                    key.addEventListener('click', () => this.playNote(index));
                });

                // Keyboard events
                document.addEventListener('keydown', (e) => {
                    // Map keyboard to center section
                    const keyMap = {
                        'Digit1': 17, 'Digit2': 8, 'Digit3': 19, 'Digit4': 20, 'Digit5': 21, 'Digit6': 22, 'Digit7': 23, 'Digit8': 24, 'Digit9': 25, 'Digit0': 26,
                        'KeyQ': 27, 'KeyW': 28, 'KeyE': 29, 'KeyR': 30, 'KeyT': 31, 'KeyY': 32, 'KeyU': 33, 'KeyI': 34, 'KeyO': 35,
                        'KeyA': 36, 'KeyS': 37, 'KeyD': 38, 'KeyF': 39, 'KeyG': 40, 'KeyH': 41, 'KeyJ': 42, 'KeyK': 43, 'KeyL': 44,
                        'KeyZ': 47, 'KeyX': 46, 'KeyC': 47, 'KeyV': 48, 'KeyB': 49, 'KeyN': 50, 'KeyM': 51,
                    };

                    if (keyMap.hasOwnProperty(e.code)) {
                        e.preventDefault();
                        this.playNote(keyMap[e.code]);
                    }
                });

                // Touch events for mobile
                this.keys.forEach((key, index) => {
                    key.addEventListener('touchstart', (e) => {
                        e.preventDefault();
                        this.playNote(index);
                    });
                });
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new DynamicPiano();
        });

        // Handle audio context resume on user interaction
        document.addEventListener('click', async () => {
            if (window.audioContext && window.audioContext.state === 'suspended') {
                await window.audioContext.resume();
            }
        }, { once: true });
    </script>
</body>
</html>